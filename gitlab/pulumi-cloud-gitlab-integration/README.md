# pulumi-gitlab-integration

The repo contains a codebase to demonstrate integration between Pulumi Cloud and GitLab. The code in this repo is based upon the following primary sources:

* <https://www.pulumi.com/docs/using-pulumi/continuous-delivery/gitlab-ci/>
* <https://www.pulumi.com/docs/using-pulumi/continuous-delivery/gitlab-app/>

## Required Configuration

Set the name of the GitLab organization in which your repository will go:

```bash
pulumi config set gitlabOrg <your-gitlab-org-name>
```

## Optional Configuration

Set the Pulumi org in which the code in the repo generated by this repo will be deployed. Default to the same org as the resources in this repo. **NOTE:** The org containing the sample stack _must_ use GitLab as its identity provider or the GitLab webhook which shows preview results as Merge Request comments will not work.

```bash
pulumi config set pulumiOrg some-other-org
```

To use this codebase with a GitLab private installation (i.e. not gitlab.com):

```bash
pulumi config set gitlabAudience "gitlab.example.com"
```

**NOTE:** This codebase is not tested with private GitLab installs and may require debugging if not run against gitlab.com. Please submit a PR for any necessary changes.

## Demo steps

1. Pre-requisites:
    1. Ensure you have a GitLab group created.
    1. Ensure your SSH key is set up in GitLab.
    1. Ensure your have a `GITLAB_TOKEN` set in your environment.
    1. Ensure you have Pulumi Org created which uses GitLab as its identity provider (a trial org should work), configured with your GitLab group as the identity source.
    1. Ensure you have AWS credentials per the provider setup.
1. Deploy the AWS OIDC resources, GitLab repo, and files:

    ```bash
    cd pulumi-cloud-gitlab-integration
    pulumi up -y
    ```

1. Copy the git clone command:

    ```bash
    pulumi stack output gitCloneCommand | pbcopy
    ```

1. Clone the repo to a temporary directory:

    ```bash
    cd $(mktemp -d) && $(pbpaste)
    ```

1. Switch to a branch in the repo:

    ```bash
    git checkout -b my-branch
    ```

1. Add a Pulumi program to the repo, e.g.:

    ```bash
    pulumi new aws-typescript --force
    ```

1. Add some resources (best to make this a single resource so the demo goes fast):

    ```bash
    const myBucket = new aws.s3.Bucket("my-gitlab-demo-bucket");
    ```

1. Push the branch:

    ```bash
    git add -A && git commit -m "Add some infra." && git push
    ```

1. Create a Merge Request in the GitLab UI. This will trigger a `pulumi preview`. If the webhook is correctly configured (i.e. if the stack's Pulumi org is configured to use the corresponding GitLab org of the repo), you will see the results of the preview operation posted as a comment to your Merge Request.
1. Merge the branch. This will trigger a `pulumi up` operation.

## Troubleshooting

Changes to `.gitlab-ci.yml` may lag behind by one commit. (Haven't tested in isolation to make sure, but the author seems to have observed this.)

If you get this error message:

```text
Failed to create GitLab Client from provider configuration: The provider failed to create a new GitLab Client from the given configuration: invalid character '<' looking for beginning of value
```

Your GitLab token is likely invalid (even though it may not show as expired). Generate a new one and reset the `GITLAB_TOKEN` env var.
